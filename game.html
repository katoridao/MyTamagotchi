<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tamagotchi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0e4ff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .game-container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 500px;
            margin: 1rem;
            box-sizing: border-box;
            position: relative;
        }
        .pet-display {
            width: 12.5rem;
            height: 12.5rem;
            margin: 0 auto 0.625rem;
            border: 2px solid #ccc;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            cursor: pointer;
        }
        .pet-display img {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            object-fit: contain;
        }
        .pet-display.jumping {
            animation: jump 1s infinite;
        }
        .pet-display.sad {
            animation: sad 1s infinite;
        }
        .pet-display.shaking {
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-0.3125rem); }
            75% { transform: translateX(0.3125rem); }
        }

        .pet-display.fading {
            animation: fade 1s infinite;
        }
        @keyframes fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-1.25rem); }
        }
        @keyframes sad {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(0.3125rem); }
        }
        .pet-status {
            font-size: 1rem;
            color: #ff6f61;
            margin: 0.625rem 0 1.25rem;
            font-weight: bold;
        }
        .action-status {
            color: #ff6f61;
            font-weight: bold;
            font-size: 1rem;
            margin-top: 0.3125rem;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .action-status.show {
            display: block;
            opacity: 1;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.5rem 0;
        }
        .shop-item span {
            font-size: 0.875rem;
        }
        .shop-item button {
            padding: 0.3125rem 0.625rem;
            font-size: 0.75rem;
        }
        .gold-display {
            position: absolute;
            top: 0.625rem;
            left: 0.625rem;
            display: flex;
            align-items: center;
            font-size: 1rem;
            font-weight: bold;
            color: #ff6f61;
        }
        .gold-icon {
            font-size: 1.5rem;
            margin-right: 0.3125rem;
            cursor: pointer;
        }
        .info-button {
            position: absolute;
            top: 0.625rem;
            right: 0.625rem;
            background-color: #ff6f61;
            color: white;
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease, background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .info-button:hover {
            background-color: #ff4f41;
            transform: scale(1.1);
        }
        .dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.25rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 90%;
            max-width: 300px;
        }
        .dialog-content {
            text-align: left;
        }
        .dialog-content p {
            margin: 0.3125rem 0;
            font-size: 0.875rem;
        }
        .close-button {
            position: absolute;
            top: 0.625rem;
            right: 0.625rem;
            background-color: #ff6f61;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.3125rem 0.625rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .close-button:hover {
            background-color: #ff4f41;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .stats {
            margin: 1.25rem 0;
            text-align: left;
            padding: 0 1.25rem;
        }
        .stat-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.9375rem;
        }
        .stat-label {
            width: 2.5rem;
            font-size: 1.25rem;
            text-align: center;
            color: #333;
            cursor: pointer;
        }
        .progress-container {
            width: 100%;
            max-width: 18.75rem;
            height: 0.9375rem;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-right: 0.9375rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #ff6f61;
            transition: width 0.3s ease;
        }
        .stat-value {
            width: 4.375rem;
            text-align: right;
            font-size: 0.875rem;
            color: #555;
        }
        .actions {
            display: flex;
            justify-content: space-around;
            margin: 1.25rem 0;
            flex-wrap: wrap;
            gap: 0.625rem;
        }
        .items {
            margin: 1.25rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.625rem;
        }
        select {
            padding: 0.3125rem;
            border-radius: 5px;
            width: 9.375rem;
            font-size: 0.875rem;
        }
        button {
            background-color: #ff6f61;
            color: white;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.3s ease;
        }
        button:hover:not(:disabled) {
            background-color: #ff4f41;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .delete-button {
            background-color: #ff4f41;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 0.9375rem;
            width: 100%;
            font-size: 0.875rem;
        }
        .delete-button:hover {
            background-color: #e43f32;
        }

        /* Tablet (max-width: 768px) */
        @media (max-width: 768px) {
            .game-container {
                max-width: 90%;
                padding: 1.5rem;
            }
            .gold-display {
                font-size: 0.9375rem;
            }
            .gold-icon {
                font-size: 1.25rem;
            }
            .pet-display {
                width: 10rem;
                height: 10rem;
            }
            .pet-status, .action-status {
                font-size: 0.9375rem;
            }
            .info-button {
                width: 2rem;
                height: 2rem;
                font-size: 1rem;
            }
            .stats {
                padding: 0 0.9375rem;
            }
            .stat-label {
                width: 2rem;
                font-size: 1rem;
            }
            .progress-container {
                max-width: 100%;
                height: 0.75rem;
            }
            .stat-value {
                width: 3.75rem;
                font-size: 0.8125rem;
            }
            .actions {
                gap: 0.5rem;
            }
            button {
                padding: 0.5rem 1rem;
                font-size: 0.8125rem;
            }
            select {
                width: 8rem;
                font-size: 0.8125rem;
            }
            .dialog {
                padding: 1rem;
            }
            .dialog-content p {
                font-size: 0.8125rem;
            }
            .close-button {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            .delete-button {
                font-size: 0.8125rem;
            }
        }

        /* Mobile (max-width: 480px) */
        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
            }
            .game-container {
                max-width: 100%;
                padding: 1rem;
                margin: 0.5rem;
            }
            .gold-display {
                font-size: 0.875rem;
            }
            .gold-icon {
                font-size: 1rem;
            }
            .pet-display {
                width: 8rem;
                height: 8rem;
            }
            .pet-status, .action-status {
                font-size: 0.875rem;
            }
            .info-button {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.875rem;
            }
            .stats {
                padding: 0 0.625rem;
            }
            .stat-label {
                width: 1.75rem;
                font-size: 0.875rem;
            }
            .progress-container {
                max-width: 100%;
                height: 0.625rem;
            }
            .stat-value {
                width: 3.125rem;
                font-size: 0.75rem;
            }
            .actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            .actions button {
                width: 100%;
                padding: 0.75rem;
            }
            .items {
                flex-direction: column;
                gap: 0.5rem;
            }
            select {
                width: 100%;
                font-size: 0.875rem;
            }
            button {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            .dialog {
                padding: 0.75rem;
            }
            .dialog-content p {
                font-size: 0.75rem;
            }
            .close-button {
                padding: 0.2rem 0.4rem;
                font-size: 0.625rem;
            }
            .delete-button {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="gold-display">
            <span class="gold-icon" onclick="showShop()">üõí</span>
            <span id="gold-amount">0 </span>
        </div>
        
        <div class="overlay" id="shop-overlay"></div>
        <div class="dialog" id="shop-dialog">
            <button class="close-button" onclick="closeShop()">X</button>
            <div class="dialog-content">
                <h3>C·ª≠a h√†ng</h3>
                <div class="shop-item">
                    <span>Th·ª©c ƒÉn ƒë·∫∑c bi·ªát (15 v√†ng)</span>
                    <button onclick="buyItem('Th·ª©c ƒÉn ƒë·∫∑c bi·ªát', 15)">Mua</button>
                </div>
                <div class="shop-item">
                    <span>Vi√™n u·ªëng con nh·ªông (10 v√†ng)</span>
                    <button onclick="buyItem('Vi√™n u·ªëng con nh·ªông', 10)">Mua</button>
                </div>
                <div class="shop-item">
                    <span>B√°nh th∆∞·ªüng (8 v√†ng)</span>
                    <button onclick="buyItem('B√°nh th∆∞·ªüng', 8)">Mua</button>
                </div>
                <div class="shop-item">
                    <span>V∆∞∆°ng li·ªám (100 v√†ng)</span>
                    <button onclick="buyItem('V∆∞∆°ng li·ªám', 100)">Mua</button>
                </div>
                <div class="shop-item">
                    <span>Rau m√° (666 v√†ng)</span>
                    <button onclick="buyItem('Rau m√°', 666)">Mua</button>
                </div>
            </div>
        </div>
        
        <div class="pet-display" id="pet-display">
            <img id="pet-image" src="" alt="Pet Image" />
        </div>
        <div class="pet-status" id="pet-status"></div>
        <div class="action-status" id="action-status"></div>
        <button class="info-button" onclick="showDialog()">i</button>
        <div class="stats">
            <div class="stat-bar">
                <span class="stat-label">‚ù§Ô∏è</span>
                <div class="progress-container">
                    <div class="progress-bar" id="health-bar" style="width: 100%;"></div>
                </div>
                <span class="stat-value" id="pet-health">100/100</span>
            </div>
            <div class="stat-bar">
                <span class="stat-label">‚ö°</span>
                <div class="progress-container">
                    <div class="progress-bar" id="energy-bar" style="width: 100%;"></div>
                </div>
                <span class="stat-value" id="pet-energy">100/100</span>
            </div>
            <div class="stat-bar">
                <span class="stat-label">üçΩÔ∏è</span>
                <div class="progress-container">
                    <div class="progress-bar" id="hunger-bar" style="width: 50%;"></div>
                </div>
                <span class="stat-value" id="pet-hunger">50/100</span>
            </div>
            <div class="stat-bar">
                <span class="stat-label">üõÅ</span>
                <div class="progress-container">
                    <div class="progress-bar" id="cleanliness-bar" style="width: 100%;"></div>
                </div>
                <span class="stat-value" id="pet-cleanliness">100/100</span>
            </div>
            <div class="stat-bar">
                <span class="stat-label">üòä</span>
                <div class="progress-container">
                    <div class="progress-bar" id="happiness-bar" style="width: 30%;"></div>
                </div>
                <span class="stat-value" id="pet-happiness">30/100</span>
            </div>
        </div>
        <div class="actions">
            <button id="play-button" onclick="playWithPet()">Ch∆°i</button>
            <button id="bathe-button" onclick="bathePet()">T·∫Øm r·ª≠a</button>
            <button id="feed-button" onclick="feedPet()">Cho ƒÉn</button>
            <button id="care-button" onclick="careForPet()">ChƒÉm s√≥c</button>
            <button id="sleep-button" onclick="sleepPet()">Ng·ªß</button>
        </div>
        <div class="items">
            <select id="item-select">
                <option value="">--Ch·ªçn v·∫≠t ph·∫©m--</option>
            </select>
            <button onclick="useItem()">D√πng v·∫≠t ph·∫©m</button>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="dialog" id="info-dialog">
        <button class="close-button" onclick="closeDialog()">X</button>
        <div class="dialog-content">
            <p><strong>T√™n:</strong> <span id="dialog-pet-name"></span></p>
            <p><strong>Lo·∫°i:</strong> <span id="dialog-pet-type"></span></p>
            <p><strong>M√†u s·∫Øc:</strong> <span id="dialog-pet-color"></span></p>
            <p><strong>Ng√†y sinh:</strong> <span id="dialog-pet-birthdate"></span></p>
            <p><strong>C·∫•p ƒë·ªô:</strong> <span id="dialog-pet-level"></span></p>
            <button class="delete-button" onclick="confirmDeletePet()">X√≥a Pet</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCgd64xynT0ppg6-E1RrPx2QEFZONTaIqM",
            authDomain: "mytamagotchi-fb787.firebaseapp.com",
            projectId: "mytamagotchi-fb787",
            storageBucket: "mytamagotchi-fb787.firebasestorage.app",
            messagingSenderId: "427722619339",
            appId: "1:427722619339:web:123996eab78d49202bde4e",
            measurementId: "G-CGZZDQRTEP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const COLOR_MAP = {
            ƒê·ªè: "#FF0000",
            L·ª•c: "#008000",
            Xanh: "#0000FF",
            V√†ng: "#FFFF00",
            H·ªìng: "#FFC0CB",
            Lam: "#00FFFF",
            T√≠m: "#800080",
            Cam: "#FFA500",
            N√¢u: "#964B00",
            Tr·∫Øng: "#FFFFFF",
            ƒêen: "#000000",
            X√°m: "#808080",
        };
        const UPDATE_INTERVAL_SECONDS = 10;
        const SLOW_DECAY_THRESHOLD_SECONDS = 300;
        const SLOW_DECAY_MULTIPLIER = 0.5;
        const WELCOME_BACK_THRESHOLD_SECONDS = 43200;
        const WELCOME_BACK_BOOST = 15;
        const PASSIVE_RECOVERY_THRESHOLD = 70;
        const PASSIVE_RECOVERY_AMOUNT = 1;

        const elements = {
            petDisplay: document.getElementById("pet-display"),
            petImage: document.getElementById("pet-image"),
            petStatus: document.getElementById("pet-status"),
            actionStatus: document.getElementById("action-status"),
            healthBar: document.getElementById("health-bar"),
            energyBar: document.getElementById("energy-bar"),
            hungerBar: document.getElementById("hunger-bar"),
            cleanlinessBar: document.getElementById("cleanliness-bar"),
            happinessBar: document.getElementById("happiness-bar"),
            petHealth: document.getElementById("pet-health"),
            petEnergy: document.getElementById("pet-energy"),
            petHunger: document.getElementById("pet-hunger"),
            petCleanliness: document.getElementById("pet-cleanliness"),
            petHappiness: document.getElementById("pet-happiness"),
            goldAmount: document.getElementById("gold-amount"),
            playButton: document.getElementById("play-button"),
            batheButton: document.getElementById("bathe-button"),
            feedButton: document.getElementById("feed-button"),
            careButton: document.getElementById("care-button"),
            sleepButton: document.getElementById("sleep-button"),
            itemSelect: document.getElementById("item-select"),
            dialogPetName: document.getElementById("dialog-pet-name"),
            dialogPetType: document.getElementById("dialog-pet-type"),
            dialogPetColor: document.getElementById("dialog-pet-color"),
            dialogPetBirthdate: document.getElementById("dialog-pet-birthdate"),
            dialogPetLevel: document.getElementById("dialog-pet-level"),
            infoDialog: document.getElementById("info-dialog"),
            overlay: document.getElementById("overlay"),
            shopOverlay: document.getElementById("shop-overlay"),
            shopDialog: document.getElementById("shop-dialog"),
        };

        const sounds = {
            hungry: new Audio('https://www.myinstants.com/media/sounds/hungry-stomach-growling.mp3'),
            sad: new Audio('https://www.myinstants.com/media/sounds/sad-cat-meow.mp3'),
            levelUp: new Audio('https://www.myinstants.com/media/sounds/level-up.mp3'),
        };

        let petData = null;
        let userData = null;
        let petId = null;
        let updateInterval = null;
        let isInteracting = false;
        let currentAction = null;
        let actionTimer = null;
        let timeLeft = 0;
        let lowStatCount = 0;
        let messageUpdateCounter = 0;
        const MESSAGE_UPDATE_INTERVAL = 3;
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');

        const actionMessages = {
            "Ch∆°i": [
                (petName, time) => `${petName} ƒëang vui v·∫ª ch∆°i ƒë√πa! C√≤n ${time} n·ªØa nh√©! üéâ`,
                (petName, time) => `${petName} ƒëang ch·∫°y nh·∫£y kh·∫Øp n∆°i! C√≤n ${time} ƒë·ªÉ vui h·∫øt m√¨nh! üèÉ`,
                (petName, time) => `${petName} ƒëang ch∆°i tr√≤ ƒëu·ªïi b·∫Øt! C√≤n ${time} n·ªØa th√¥i! üí®`
            ],
            "T·∫Øm r·ª≠a": [
                (petName, time) => `${petName} ƒëang th∆∞ gi√£n trong b·ªìn t·∫Øm! C√≤n ${time} n·ªØa th√¥i! üõÅ`,
                (petName, time) => `${petName} ƒëang ngh·ªãch n∆∞·ªõc tung t√≥e! C√≤n ${time} ƒë·ªÉ s·∫°ch s·∫Ω! üí¶`,
                (petName, time) => `${petName} ƒëang th√≠ch th√∫ v·ªõi b·ªçt x√† ph√≤ng! C√≤n ${time} n·ªØa nh√©! üßº`
            ],
            "Cho ƒÉn": [
                (petName, time) => `${petName} ƒëang ƒÉn ngon l√†nh! C√≤n ${time} ƒë·ªÉ no b·ª•ng! üçΩÔ∏è`,
                (petName, time) => `${petName} ƒëang nhai nh√≥p nh√©p! C√≤n ${time} n·ªØa th√¥i! ü•Ñ`,
                (petName, time) => `${petName} ƒëang th∆∞·ªüng th·ª©c b·ªØa ƒÉn! C√≤n ${time} ƒë·ªÉ no n√™! üç¥`
            ],
            "ChƒÉm s√≥c": [
                (petName, time) => `${petName} ƒëang ƒë∆∞·ª£c chƒÉm s√≥c c·∫©n th·∫≠n! C√≤n ${time} n·ªØa th√¥i! ‚ù§Ô∏è`,
                (petName, time) => `${petName} ƒëang c·∫£m nh·∫≠n s·ª± y√™u th∆∞∆°ng! C√≤n ${time} ƒë·ªÉ kh·ªèe m·∫°nh! üíñ`,
                (petName, time) => `${petName} ƒëang ƒë∆∞·ª£c vu·ªët ve nh·∫π nh√†ng! C√≤n ${time} n·ªØa nh√©! üêæ`
            ],
            "Ng·ªß": [
                (petName, time) => `${petName} ƒëang ng·ªß ngon gi·∫•c! C√≤n ${time} ƒë·ªÉ t·ªânh t√°o! üí§`,
                (petName, time) => `${petName} ƒëang m∆° m·ªông trong gi·∫•c ng·ªß! C√≤n ${time} n·ªØa th√¥i! üåô`,
                (petName, time) => `${petName} ƒëang ng√°y kh√≤ kh√≤! C√≤n ${time} ƒë·ªÉ ngh·ªâ ng∆°i! üò¥`
            ]
        };

        async function loadPet() {
            if (!uid) {
                alert("Kh√¥ng t√¨m th·∫•y UID ng∆∞·ªùi d√πng!");
                return window.location.href = "index.html";
            }

            try {
                const userRef = doc(db, "Users", uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, { gold: 0, items: [], currentPetId: null });
                    alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng! H√£y t·∫°o pet m·ªõi.");
                    return window.location.href = `creation.html?uid=${uid}`;
                }

                userData = userSnap.data();
                if (!userData.currentPetId) {
                    alert("Kh√¥ng t√¨m th·∫•y pet!");
                    return window.location.href = `creation.html?uid=${uid}`;
                }

                petId = userData.currentPetId;
                const petRef = doc(db, "Pets", petId);
                const petSnap = await getDoc(petRef);
                if (petSnap.exists()) {
                    petData = petSnap.data();
                    petData.nextLevelExp = 100 + (petData.level - 1) * 50;
                    await updateStatsBasedOnTime();
                    applyWelcomeBackBoost();
                    populateItems();
                    displayPet();
                    startStatUpdates();
                } else {
                    alert("Kh√¥ng t√¨m th·∫•y pet!");
                    window.location.href = `creation.html?uid=${uid}`;
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i pet:", error);
                alert("L·ªói khi t·∫£i pet: " + error.message);
            }
        }

        function populateItems() {
            elements.itemSelect.innerHTML = '<option value="">--Ch·ªçn v·∫≠t ph·∫©m--</option>';
            userData.items.forEach(item => {
                const option = document.createElement("option");
                option.value = option.textContent = item;
                elements.itemSelect.appendChild(option);
            });
        }

        function getPetStatus() {
            const allStats = [petData.health, petData.energy, petData.hunger, petData.cleanliness, petData.happiness];
            if (allStats.every(stat => stat > 80)) {
                return `${petData.petName} ƒëang c·∫£m th·∫•y Tuy·ªát v·ªùi! üéâ`;
            }

            if (petData.health < 30) return `${petData.petName} ƒëang ·ªêm y·∫øu ü§í`;
            if (petData.energy < 30) return `${petData.petName} ƒëang Ng√°i ng·ªß üí§`;
            if (petData.hunger < 30) return `${petData.petName} ƒëang ƒê√≥i üçΩÔ∏è`;
            if (petData.cleanliness < 30) return `${petData.petName} ƒëang B·∫©n üêæ`;
            if (petData.happiness < 30) return `${petData.petName} ƒëang Bu·ªìn üò¢`;

            return `${petData.petName} ƒëang c·∫£m th·∫•y b√¨nh th∆∞·ªùng`;
        }

        function displayPet() {
            elements.petHealth.textContent = `${petData.health}/100`;
            elements.petEnergy.textContent = `${petData.energy}/100`;
            elements.petHunger.textContent = `${petData.hunger}/100`;
            elements.petCleanliness.textContent = `${petData.cleanliness}/100`;
            elements.petHappiness.textContent = `${petData.happiness}/100`;
            elements.healthBar.style.width = `${petData.health}%`;
            elements.energyBar.style.width = `${petData.energy}%`;
            elements.hungerBar.style.width = `${petData.hunger}%`;
            elements.cleanlinessBar.style.width = `${petData.cleanliness}%`;
            elements.happinessBar.style.width = `${petData.happiness}%`;
            elements.goldAmount.textContent = userData.gold;

            elements.dialogPetName.textContent = petData.petName;
            elements.dialogPetType.textContent = petData.petType;
            elements.dialogPetColor.textContent = petData.color;
            elements.dialogPetBirthdate.textContent = petData.birthDate;
            elements.dialogPetLevel.textContent = petData.level;

            elements.petDisplay.style.backgroundColor = COLOR_MAP[petData.color] || "#fff";
            elements.petDisplay.classList.remove("jumping", "sad", "shaking", "fading");

            const petType = petData.petType.toLowerCase();
            const petImage = elements.petImage;

            if (isInteracting && currentAction) {
                const actionImageMap = {
                    "Ch∆°i": "playing",
                    "T·∫Øm r·ª≠a": "bathing",
                    "Cho ƒÉn": "eating",
                    "ChƒÉm s√≥c": "caring",
                    "Ng·ªß": "sleeping"
                };
                const actionImage = actionImageMap[currentAction];
                petImage.src = `img/${petType}/${actionImage}.png`;

                const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const seconds = (timeLeft % 60).toString().padStart(2, '0');
                const timeDisplay = `${minutes}:${seconds}`;
                const messages = actionMessages[currentAction];
                let message;
                if (messages && messageUpdateCounter % MESSAGE_UPDATE_INTERVAL === 0) {
                    message = messages[Math.floor(Math.random() * messages.length)](petData.petName, timeDisplay);
                } else {
                    message = elements.actionStatus.textContent.replace(/\d{2}:\d{2}/, timeDisplay);
                }
                elements.actionStatus.textContent = message;
                elements.actionStatus.classList.add("show");
            } else {
                const allStats = [petData.health, petData.energy, petData.hunger, petData.cleanliness, petData.happiness];
                if (allStats.every(stat => stat > 80)) {
                    petImage.src = `img/${petType}/happy.png`;
                    elements.petDisplay.classList.add("jumping");
                } else if (petData.health < 30) {
                    petImage.src = `img/${petType}/sick.png`;
                } else if (petData.energy < 30) {
                    petImage.src = `img/${petType}/asleep.png`;
                    elements.petDisplay.classList.add("fading");
                } else if (petData.hunger < 30) {
                    petImage.src = `img/${petType}/hungry.png`;
                    elements.petDisplay.classList.add("shaking");
                    sounds.hungry.play();
                } else if (petData.cleanliness < 30) {
                    petImage.src = `img/${petType}/dirty.png`;
                } else if (petData.happiness < 30) {
                    petImage.src = `img/${petType}/sad.png`;
                    elements.petDisplay.classList.add("sad");
                    sounds.sad.play();
                } else {
                    petImage.src = `img/${petType}/normal.png`;
                }
                elements.actionStatus.classList.remove("show");
            }

            elements.petStatus.textContent = getPetStatus();
        }

        async function applyWelcomeBackBoost() {
            if (!petData.lastUpdated) return;

            const lastUpdated = petData.lastUpdated.toDate();
            const now = new Date();
            const timeDiffSeconds = Math.floor((now - lastUpdated) / 1000);

            if (timeDiffSeconds >= WELCOME_BACK_THRESHOLD_SECONDS) {
                petData.health = Math.min(petData.health + WELCOME_BACK_BOOST, 100);
                petData.energy = Math.min(petData.energy + WELCOME_BACK_BOOST, 100);
                petData.hunger = Math.min(petData.hunger + WELCOME_BACK_BOOST, 100);
                petData.cleanliness = Math.min(petData.cleanliness + WELCOME_BACK_BOOST, 100);
                petData.happiness = Math.min(petData.happiness + WELCOME_BACK_BOOST, 100);
                alert(`Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i! ${petData.petName} r·∫•t vui khi g·∫∑p l·∫°i b·∫°n v√† ƒë√£ ƒë∆∞·ª£c h·ªìi ph·ª•c +${WELCOME_BACK_BOOST} cho t·∫•t c·∫£ ch·ªâ s·ªë!`);
                petData.lastUpdated = serverTimestamp();
                await updatePet();
            }
        }

        async function updateStatsBasedOnTime() {
            if (!petData.lastUpdated) {
                petData.lastUpdated = serverTimestamp();
                return await updatePet();
            }

            const lastUpdated = petData.lastUpdated.toDate();
            const now = new Date();
            const timeDiffSeconds = Math.floor((now - lastUpdated) / 1000);
            const updatesMissed = Math.floor(timeDiffSeconds / UPDATE_INTERVAL_SECONDS);

            if (updatesMissed > 0) {
                let decayMultiplier = 1;
                if (timeDiffSeconds >= SLOW_DECAY_THRESHOLD_SECONDS) {
                    decayMultiplier = SLOW_DECAY_MULTIPLIER;
                }

                const healthDecay = Math.min(0.5 * updatesMissed * decayMultiplier, 40);
                const energyDecay = Math.min(1 * updatesMissed * decayMultiplier, 40);
                const hungerDecay = Math.min(1 * updatesMissed * decayMultiplier, 40);
                const cleanlinessDecay = Math.min(0.5 * updatesMissed * decayMultiplier, 40);
                const happinessDecay = Math.min(0.5 * updatesMissed * decayMultiplier, 40);

                petData.health = Math.max(petData.health - healthDecay, 0);
                petData.energy = Math.max(petData.energy - energyDecay, 0);
                petData.hunger = Math.max(petData.hunger - hungerDecay, 0);
                petData.cleanliness = Math.max(petData.cleanliness - cleanlinessDecay, 0);
                petData.happiness = Math.max(petData.happiness - happinessDecay, 0);

                petData.lastUpdated = serverTimestamp();
                await updatePet();
            }
        }

        function startStatUpdates() {
            updateInterval = setInterval(async () => {
                // Online decay
                petData.health = Math.max(petData.health - 0.5, 0);
                petData.energy = Math.max(petData.energy - 1, 0);
                petData.hunger = Math.max(petData.hunger - 1.5, 0);
                petData.cleanliness = Math.max(petData.cleanliness - 0.5, 0);
                petData.happiness = Math.max(petData.happiness - 1, 0);

                // Additional health penalty
                const lowStats = [petData.energy, petData.hunger, petData.cleanliness, petData.happiness].filter(stat => stat < 30).length;
                if (lowStats > 0) {
                    lowStatCount++;
                    if (lowStatCount >= 3) {
                        petData.health = Math.max(petData.health - 5, 0);
                        lowStatCount = 0;
                    }
                } else {
                    lowStatCount = 0;
                }

                // Passive recovery
                const allStats = [petData.health, petData.energy, petData.hunger, petData.cleanliness, petData.happiness];
                if (allStats.every(stat => stat >= PASSIVE_RECOVERY_THRESHOLD)) {
                    petData.health = Math.min(petData.health + PASSIVE_RECOVERY_AMOUNT, 100);
                    petData.energy = Math.min(petData.energy + PASSIVE_RECOVERY_AMOUNT, 100);
                    petData.hunger = Math.min(petData.hunger + PASSIVE_RECOVERY_AMOUNT, 100);
                    petData.cleanliness = Math.min(petData.cleanliness + PASSIVE_RECOVERY_AMOUNT, 100);
                    petData.happiness = Math.min(petData.happiness + PASSIVE_RECOVERY_AMOUNT, 100);
                }

                // Exp gains
                if (allStats.every(stat => stat > 80)) {
                    petData.exp += 3;
                } else if (allStats.every(stat => stat > 50)) {
                    petData.exp += 2;
                }

                // Level up
                if (petData.exp >= petData.nextLevelExp) {
                    petData.level += 1;
                    petData.exp = 0;
                    petData.nextLevelExp = 100 + (petData.level - 1) * 50;
                    const goldReward = 15 + (petData.level - 1) * 10;
                    userData.gold += goldReward;
                    sounds.levelUp.play();
                    alert(`Ch√∫c m·ª´ng! ${petData.petName} ƒë√£ l√™n c·∫•p ${petData.level}! B·∫°n nh·∫≠n ƒë∆∞·ª£c ${goldReward} v√†ng!`);
                }

                petData.lastUpdated = serverTimestamp();
                await updatePet();
                displayPet();
            }, UPDATE_INTERVAL_SECONDS * 1000);
        }

        async function updatePet() {
            try {
                const petRef = doc(db, "Pets", petId);
                await updateDoc(petRef, petData);

                const userRef = doc(db, "Users", uid);
                await updateDoc(userRef, {
                    gold: userData.gold,
                    items: userData.items,
                    currentPetId: userData.currentPetId
                });

                console.log("Pet and user updated successfully!");
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t pet:", error);
                alert("L·ªói khi c·∫≠p nh·∫≠t pet: " + error.message);
            }
        }

        async function deletePet() {
            try {
                const petRef = doc(db, "Pets", petId);
                await deleteDoc(petRef);

                const userRef = doc(db, "Users", uid);
                await updateDoc(userRef, { currentPetId: null });

                console.log("Pet deleted successfully!");
                alert(`${petData.petName} ƒë√£ ƒë∆∞·ª£c g·ª≠i v√†o trung t√¢m!`);
                window.location.href = `creation.html?uid=${uid}`;
            } catch (error) {
                console.error("L·ªói khi x√≥a pet:", error);
                alert("L·ªói khi x√≥a pet: " + error.message);
            }
        }

        function startInteraction(actionName, duration, callback) {
            if (isInteracting) return alert(`${petData.petName} ƒëang b·∫≠n, h√£y ƒë·ª£i m·ªôt ch√∫t!`);

            isInteracting = true;
            currentAction = actionName;
            timeLeft = duration;
            messageUpdateCounter = 0;

            elements.playButton.disabled = true;
            elements.batheButton.disabled = true;
            elements.feedButton.disabled = true;
            elements.careButton.disabled = true;
            elements.sleepButton.disabled = true;

            displayPet();

            actionTimer = setInterval(() => {
                timeLeft--;
                messageUpdateCounter++;

                displayPet();

                if (timeLeft <= 0) {
                    clearInterval(actionTimer);
                    isInteracting = false;
                    currentAction = null;
                    timeLeft = 0;
                    messageUpdateCounter = 0;
                    callback();
                    elements.playButton.disabled = false;
                    elements.batheButton.disabled = false;
                    elements.feedButton.disabled = false;
                    elements.careButton.disabled = false;
                    elements.sleepButton.disabled = false;
                    elements.actionStatus.classList.remove("show");
                    displayPet();
                }
            }, 1000);
        }

        window.feedPet = async () => {
            if (petData.hunger >= 100) return alert(`${petData.petName} ƒë√£ no, kh√¥ng th·ªÉ cho ƒÉn th√™m!`);
            startInteraction("Cho ƒÉn", 5, async () => {
                petData.hunger = Math.min(petData.hunger + 30, 100);
                petData.happiness = Math.min(petData.happiness + 10, 100);
                petData.energy = Math.max(petData.energy - 3, 0);
                petData.cleanliness = Math.max(petData.cleanliness - 1, 0);
                petData.exp += 15;
                userData.gold += 5;
                petData.lastUpdated = serverTimestamp();
                await updatePet();
                displayPet();
            });
        };

        window.playWithPet = async () => {
            startInteraction("Ch∆°i", 8, async () => {
                petData.happiness = Math.min(petData.happiness + 25, 100);
                petData.energy = Math.max(petData.energy - 5, 0);
                petData.hunger = Math.max(petData.hunger - 5, 0);
                petData.cleanliness = Math.max(petData.cleanliness - 3, 0);
                petData.exp += 20;
                userData.gold += 5;
                petData.lastUpdated = serverTimestamp();
                await updatePet();
                displayPet();
            });
        };

        window.bathePet = async () => {
            if (petData.cleanliness >= 100) return alert(`${petData.petName} ƒë√£ s·∫°ch s·∫Ω, kh√¥ng c·∫ßn t·∫Øm th√™m!`);
            startInteraction("T·∫Øm r·ª≠a", 6, async () => {
                const wasDirty = petData.cleanliness < 30;
                petData.cleanliness = Math.min(petData.cleanliness + 30, 100);
                petData.happiness = Math.min(petData.happiness + 15, 100);
                if (wasDirty) petData.happiness = Math.min(petData.happiness + 10, 100);
                petData.energy = Math.max(petData.energy - 3, 0);
                petData.exp += 15;
                userData.gold += 4;
                petData.lastUpdated = serverTimestamp();
                await updatePet();
                displayPet();
            });
        };

        window.careForPet = async () => {
            if (petData.health >= 100) return alert(`${petData.petName} ƒë√£ kh·ªèe m·∫°nh, kh√¥ng c·∫ßn chƒÉm s√≥c th√™m!`);
            startInteraction("ChƒÉm s√≥c", 10, async () => {
                const wasSick = petData.health < 30;
                petData.health = Math.min(petData.health + 25, 100);
                petData.happiness = Math.min(petData.happiness + 15, 100);
                if (wasSick) petData.happiness = Math.min(petData.happiness + 10, 100);
                petData.energy = Math.max(petData.energy - 3, 0);
                petData.exp += 25;
                userData.gold += 6;
                petData.lastUpdated = serverTimestamp();
                await updatePet();
                displayPet();
            });
        };

        window.sleepPet = async () => {
            if (petData.energy >= 100) return alert(`${petData.petName} ƒë√£ ƒë·∫ßy nƒÉng l∆∞·ª£ng, kh√¥ng c·∫ßn ng·ªß th√™m!`);
            startInteraction("Ng·ªß", 12, async () => {
                const wasAsleep = petData.energy < 30;
                petData.energy = Math.min(petData.energy + 40, 100);
                petData.hunger = Math.max(petData.hunger - 3, 0);
                petData.happiness = Math.max(petData.happiness - 3, 0);
                petData.cleanliness = Math.max(petData.cleanliness - 2, 0);
                if (wasAsleep) petData.happiness = Math.min(petData.happiness + 10, 100);
                petData.exp += 15;
                userData.gold += 5;
                petData.lastUpdated = serverTimestamp();
                await updatePet();
                displayPet();
            });
        };

        window.useItem = async () => {
            const selectedItem = elements.itemSelect.value;
            if (!selectedItem) return alert("Vui l√≤ng ch·ªçn m·ªôt v·∫≠t ph·∫©m!");

            if (selectedItem === "Th·ª©c ƒÉn ƒë·∫∑c bi·ªát") {
                petData.hunger = Math.min(petData.hunger + 40, 100);
                petData.happiness = Math.min(petData.happiness + 10, 100);
                petData.energy = Math.min(petData.energy + 5, 100);
                alert(`${petData.petName} ƒë√£ d√πng Th·ª©c ƒÉn ƒë·∫∑c bi·ªát! Hunger +40, Happiness +10, Energy +5`);
            } else if (selectedItem === "Vi√™n u·ªëng con nh·ªông") {
                petData.health = Math.min(petData.health + 30, 100);
                petData.energy = Math.min(petData.energy + 10, 100);
                petData.happiness = Math.min(petData.happiness + 5, 100);
                alert(`${petData.petName} ƒë√£ d√πng Vi√™n u·ªëng con nh·ªông! Health +30, Energy +10, Happiness +5`);
            } else if (selectedItem === "B√°nh th∆∞·ªüng") {
                petData.happiness = Math.min(petData.happiness + 20, 100);
                petData.hunger = Math.min(petData.hunger + 15, 100);
                petData.energy = Math.max(petData.energy - 5, 0);
                alert(`${petData.petName} ƒë√£ d√πng B√°nh th∆∞·ªüng! Happiness +20, Hunger +15, Energy -5`);
            } else if (selectedItem === "V∆∞∆°ng li·ªám") {
                const stats = ["hunger", "cleanliness", "health", "energy", "happiness"];
                const statNames = {
                    hunger: "Hunger",
                    cleanliness: "Cleanliness",
                    health: "Health",
                    energy: "Energy",
                    happiness: "Happiness"
                };
                
                const numStatsToAffect = Math.floor(Math.random() * 5) + 1;
                const shuffledStats = stats.sort(() => Math.random() - 0.5);
                const affectedStats = shuffledStats.slice(0, numStatsToAffect);
                
                let effectMessage = `${petData.petName} ƒë√£ ch∆°i V∆∞∆°ng li·ªám! Hi·ªáu ·ª©ng:\n`;
                
                affectedStats.forEach(stat => {
                    const changeValue = Math.floor(Math.random() * 101);
                    const isIncrease = Math.random() < 0.5;
                    
                    const previousValue = petData[stat];
                    if (isIncrease) {
                        petData[stat] = Math.min(petData[stat] + changeValue, 100);
                        effectMessage += `${statNames[stat]} +${changeValue} (t·ª´ ${previousValue} l√™n ${petData[stat]})\n`;
                    } else {
                        petData[stat] = Math.max(petData[stat] - changeValue, 0);
                        effectMessage += `${statNames[stat]} -${changeValue} (t·ª´ ${previousValue} xu·ªëng ${petData[stat]})\n`;
                    }
                });
                
                alert(effectMessage);
            } else if (selectedItem === "Rau m√°") {
                petData.health = Math.min(petData.health + 20, 100);
                petData.energy = Math.min(petData.energy + 20, 100);
                petData.hunger = Math.min(petData.hunger + 20, 100);
                petData.cleanliness = Math.min(petData.cleanliness + 20, 100);
                petData.happiness = Math.min(petData.happiness + 20, 100);
                let effectMessage = `${petData.petName} ƒë√£ d√πng Rau m√°! T·∫•t c·∫£ ch·ªâ s·ªë +20`;
                if (userData.items.length > 1) {
                    const remainingItems = userData.items.filter(item => item !== "Rau m√°");
                    if (remainingItems.length > 0) {
                        const randomIndex = Math.floor(Math.random() * remainingItems.length);
                        const removedItem = remainingItems[randomIndex];
                        userData.items = userData.items.filter(item => item !== removedItem);
                        effectMessage += `, nh∆∞ng b·∫°n ƒë√£ m·∫•t ${removedItem}!`;
                    }
                }
                alert(effectMessage);
            }

            userData.items = userData.items.filter(item => item !== selectedItem);
            await updatePet();
            populateItems();
            displayPet();
        };

        window.showShop = () => {
            elements.shopDialog.style.display = "block";
            elements.shopOverlay.style.display = "block";
        };

        window.closeShop = () => {
            elements.shopDialog.style.display = "none";
            elements.shopOverlay.style.display = "none";
        };

        window.buyItem = async (itemName, cost) => {
            if (userData.gold < cost) {
                alert("B·∫°n kh√¥ng ƒë·ªß v√†ng ƒë·ªÉ mua v·∫≠t ph·∫©m n√†y!");
                return;
            }

            userData.gold -= cost;
            userData.items.push(itemName);
            alert(`B·∫°n ƒë√£ mua ${itemName}!`);

            await updatePet();
            populateItems();
            displayPet();
        };

        window.showDialog = () => {
            elements.infoDialog.style.display = "block";
            elements.overlay.style.display = "block";
        };

        window.closeDialog = () => {
            elements.infoDialog.style.display = "none";
            elements.overlay.style.display = "none";
        };

        window.confirmDeletePet = () => {
            if (window.confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g·ª≠i ${petData.petName} v√†o trung t√¢m? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                deletePet();
            } else {
                closeDialog();
            }
        };

        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (uid && uid === user.uid) {
                    loadPet();
                } else {
                    alert("UID kh√¥ng h·ª£p l·ªá! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                    window.location.href = "index.html";
                }
            } else {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem pet!");
                window.location.href = "index.html";
            }
        });
    </script>
</body>
</html>